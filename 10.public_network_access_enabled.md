# Task #10: public_network_access_enabled

## Summary

Implemented `public_network_access_enabled` field conversion from azurerm_container_registry to azapi_resource. The field is Optional with default `true`, converts boolean to Azure API string ("Enabled"/"Disabled"), and requires Premium SKU when disabled.

## Shadow Implementation

```hcl
# variables.tf
variable "public_network_access_enabled" {
  type        = bool  # <-
  default     = true  # <-
  nullable    = false  # <-
  description = "(Optional) Whether public network access is allowed for the container registry. Defaults to `true`."  # <-

  validation {  # <-
    condition     = var.public_network_access_enabled == true || var.sku == "Premium"  # <-
    error_message = "`public_network_access_enabled` can only be disabled for a Premium Sku"  # <-
  }  # <-
}

# migrate_main.tf
locals {
  body = {
    properties = {
      publicNetworkAccess = var.public_network_access_enabled ? "Enabled" : "Disabled"  # <-
    }
  }
}
```

## Create Phase Verification (MANDATORY)

**Query Result:** Analyzed `resourceContainerRegistryCreate` function (lines 405-531).

**Pattern Identification:** Single-phase creation pattern.

**Go Code Evidence:**
```go
// Lines 465-475 in resourceContainerRegistryCreate
publicNetworkAccess := registries.PublicNetworkAccessEnabled
if !d.Get("public_network_access_enabled").(bool) {
	if !strings.EqualFold(sku, string(registries.SkuNamePremium)) {
		return errors.New("`public_network_access_enabled` can only be disabled for a Premium Sku")
	}

	publicNetworkAccess = registries.PublicNetworkAccessDisabled
}

// Lines 493-509 in resourceContainerRegistryCreate - assignment
parameters := registries.Registry{
	Location: location.Normalize(d.Get("location").(string)),
	Sku: registries.Sku{
		Name: registries.SkuName(sku),
		Tier: pointer.To(registries.SkuTier(sku)),
	},
	Identity: identity,
	Properties: &registries.RegistryProperties{
		AdminUserEnabled: pointer.To(d.Get("admin_enabled").(bool)),
		// ... other fields ...
		PublicNetworkAccess: &publicNetworkAccess,
		// ... other fields ...
	},
	Tags: tags.Expand(d.Get("tags").(map[string]interface{})),
}

// Line 517
if err := client.CreateThenPoll(ctx, id, parameters); err != nil {
	return fmt.Errorf("creating %s: %+v", id, err)
}
```

**Decision:** Field is set during primary Create operation before `CreateThenPoll`. This is a standard root-level argument that belongs in `local.body.properties`.

## Assignment Path Verification (MANDATORY)

**Predicted Path:** `properties.publicNetworkAccess`

**Go Code Trace:**
```go
// Step 1: Field read and conversion (lines 465-475)
publicNetworkAccess := registries.PublicNetworkAccessEnabled  // Default value
if !d.Get("public_network_access_enabled").(bool) {
	publicNetworkAccess = registries.PublicNetworkAccessDisabled
}

// Step 2: Assignment to Properties struct (line 509)
Properties: &registries.RegistryProperties{
	PublicNetworkAccess: &publicNetworkAccess,
}

// Step 3: Properties assigned to parameters (lines 493-495)
parameters := registries.Registry{
	Properties: &registries.RegistryProperties{
		PublicNetworkAccess: &publicNetworkAccess,
	},
}
```

**Verified Path:** `body.properties.publicNetworkAccess`

**Path Comparison:** ✅ Match - The predicted path matches the verified path exactly.

## Provider Schema

**Source:** `internal/services/containers/container_registry_resource.go` (lines 125-129)

```go
"public_network_access_enabled": {
	Type:     pluginsdk.TypeBool,
	Optional: true,
	Default:  true,
},
```

**Key Attributes:**
- Type: Bool
- Optional: true
- Default: true
- ForceNew: false (not specified, defaults to false)
- Sensitive: false
- DiffSuppressFunc: none

## Azure API Schema

**Resource Type:** `Microsoft.ContainerRegistry/registries@2025-04-01`

**Property Path:** `body.properties.publicNetworkAccess`

**Type:** String

**Description:** "Whether or not public network access is allowed for the container registry. (Possible values: Enabled,Disabled)"

**Schema Details:**
- API Type: String (enum: "Enabled", "Disabled")
- Provider Type: Bool (true/false)
- Conversion Required: Yes - bool to string transformation

## Hidden Fields

None - This is a standard documented field with no hidden dependencies.

## Mapping

| Provider (snake_case) | Azure API (camelCase) | Notes |
|----------------------|----------------------|-------|
| `public_network_access_enabled` | `publicNetworkAccess` | Bool → String conversion ("Enabled"/"Disabled") |

## Special Handling

### 1. Validation (IMPLEMENTED in variables.tf)

**Provider Validation - Create Phase (lines 468-473):**
```go
publicNetworkAccess := registries.PublicNetworkAccessEnabled
if !d.Get("public_network_access_enabled").(bool) {
	if !strings.EqualFold(sku, string(registries.SkuNamePremium)) {
		return errors.New("`public_network_access_enabled` can only be disabled for a Premium Sku")
	}
	publicNetworkAccess = registries.PublicNetworkAccessDisabled
}
```

**Provider Validation - Update Phase (lines 689-697):**
```go
if d.HasChange("public_network_access_enabled") {
	publicNetworkAccess := registries.PublicNetworkAccessEnabled
	if !d.Get("public_network_access_enabled").(bool) {
		if !isPremiumSku {
			return errors.New("`public_network_access_enabled` can only be disabled for a Premium Sku")
		}
		publicNetworkAccess = registries.PublicNetworkAccessDisabled
	}
	payload.Properties.PublicNetworkAccess = pointer.To(publicNetworkAccess)
}
```

**Implementation (variables.tf):**
```hcl
validation {
  condition     = var.public_network_access_enabled == true || var.sku == "Premium"
  error_message = "`public_network_access_enabled` can only be disabled for a Premium Sku"
}
```

**Justification:** Cross-variable validation is supported in Terraform 1.9+. This validation checks that when `public_network_access_enabled` is disabled (false), the SKU must be Premium. The condition `var.public_network_access_enabled == true || var.sku == "Premium"` is logically equivalent to the provider's check.

### 2. Default Value (IMPLEMENTED in variables.tf)

**Provider Default (line 128):** `Default: true`

**Implementation:**
```hcl
variable "public_network_access_enabled" {
  type        = bool
  default     = true
  nullable    = false
}
```

**Justification:** Root-level arguments with defaults MUST have both `default` value AND `nullable = false` set (per executor.md).

### 3. Type Conversion (IMPLEMENTED in migrate_main.tf)

**Provider Conversion Logic (lines 465-475):**
```go
publicNetworkAccess := registries.PublicNetworkAccessEnabled  // When true
if !d.Get("public_network_access_enabled").(bool) {
	publicNetworkAccess = registries.PublicNetworkAccessDisabled  // When false
}
```

**Constants from SDK:**
```go
// From resource-manager/containerregistry/2025-04-01/registries/constants.go
const (
	PublicNetworkAccessEnabled  PublicNetworkAccess = "Enabled"
	PublicNetworkAccessDisabled PublicNetworkAccess = "Disabled"
)
```

**Implementation:**
```hcl
publicNetworkAccess = var.public_network_access_enabled ? "Enabled" : "Disabled"
```

**Justification:** Exact replication of provider's boolean-to-enum conversion logic.

### 4. ForceNew (NOT REQUIRED)

**Schema Analysis:** No `ForceNew: true` in schema definition.

**CustomizeDiff Analysis:** No CustomizeDiff logic for this field's changes.

**Update Method Analysis (lines 686-698):** Field is explicitly handled in Update method with `HasChange` check and can be updated in place.

**Conclusion:** No ForceNew trigger needed. Field can be updated without resource recreation.

### 5. Referenced in Other Validations

**Cross-Field Validation (export_policy_enabled):**

This field is referenced in the `export_policy_enabled` validation (already implemented in Task #8):

```go
// Lines 354-360 in CustomizeDiff
exportPolicyEnabled := d.Get("export_policy_enabled").(bool)
if !exportPolicyEnabled {
	if !strings.EqualFold(sku, string(registries.SkuNamePremium)) {
		return errors.New("an ACR export policy can only be disabled when using the Premium Sku. If you are downgrading from a Premium SKU please unset `export_policy_enabled` or set `export_policy_enabled = true`")
	}
	if d.Get("public_network_access_enabled").(bool) {
		return errors.New("to disable export of artifacts, `public_network_access_enabled` must also be `false`")
	}
}
```

**Already Implemented in Task #8 (variables.tf):**
```hcl
variable "export_policy_enabled" {
  # ...
  validation {
    condition     = var.export_policy_enabled == true || var.public_network_access_enabled == false
    error_message = "to disable export of artifacts, `public_network_access_enabled` must also be `false`"
  }
}
```

**No Action Required:** The cross-field validation was already correctly implemented in Task #8.

## Deferred Work Completion (MANDATORY if applicable)

**Checked `following.md`:** File does not exist, no deferred work pending for this task.

**Deferred Work Status:** N/A - No work was deferred to this task.

## Critical Review & Edge Case

### Null Semantics
- **Provider Default:** `true` (line 128)
- **Implementation:** `default = true`, `nullable = false`
- **Null Handling:** Not applicable - field cannot be null due to `nullable = false` and has explicit default

### Boundary Conditions
1. **SKU Constraint:**
   - When `false`: Must be Premium SKU (validated)
   - When `true`: Any SKU allowed
   - Edge case: Attempting to disable with Basic/Standard SKU → Validation catches at plan time

2. **Cross-Field Dependencies:**
   - `export_policy_enabled = false` requires `public_network_access_enabled = false` (already validated in Task #8)
   - Circular dependency handled: This validation is owned by export_policy_enabled variable

### Idempotency
- **Value Stability:** Boolean input consistently maps to same string output
- **No Order Dependency:** Single value field, no ordering concerns
- **Repeated Applies:** Same input always produces same output ("Enabled" or "Disabled")

### Safe References
- **Variable Reference:** Direct access to `var.public_network_access_enabled` and `var.sku`
- **No Nested Access:** No null-safety concerns for field access
- **Type Safety:** Boolean type enforced by Terraform type system

### Edge Case Analysis

**Edge Case 1: Disabling with non-Premium SKU**
- **Scenario:** User sets `public_network_access_enabled = false` with `sku = "Basic"`
- **Mitigation:** Validation block catches this at plan time
- **Expected Behavior:** Terraform plan fails with clear error message before API call

**Edge Case 2: Enabling from disabled state**
- **Scenario:** Change from `false` → `true` (any SKU)
- **Behavior:** Allowed by validation, updates in place (no ForceNew)
- **Provider Behavior:** Update method handles this (lines 686-698)

**Edge Case 3: SKU downgrade with disabled access**
- **Scenario:** User has Premium SKU with disabled access, then downgrades SKU
- **Behavior:** Validation will fail because disabled access requires Premium
- **Provider Behavior:** Similar validation in Update method (line 694)
- **Mitigation:** User must enable access before downgrading SKU

**Edge Case 4: Default value inheritance**
- **Scenario:** User doesn't specify the field
- **Behavior:** Defaults to `true`, sends "Enabled" to API
- **Provider Behavior:** Matches provider default (line 128)

## Checklist

- ✅ Property in correct local (`body.properties.publicNetworkAccess`)
- ✅ Default value implemented (`default = true`, `nullable = false`)
- ✅ ForceNew NOT needed (field is updatable)
- ✅ ALL logic EXACTLY replicated from provider (validation + type conversion)
- ✅ Validations IMPLEMENTED in variables.tf (MANDATORY - SKU constraint)
- ✅ TODO comment NOT needed (not a sensitive field migration)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md (N/A - not deferring any work)
- ✅ Deferred work from following.md (N/A - no work deferred to this task)
- ✅ Critical review completed (null, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis in proof (4 edge cases documented)
- ✅ Proof created (this document)
- ✅ `track.md` ready to update to "Pending for check"
- ✅ Self-Review: Only added public_network_access_enabled field implementation, no other fields
- ✅ Type conversion exactly matches provider (bool → "Enabled"/"Disabled")
- ✅ Cross-variable validation uses Terraform 1.9+ capability

## Files Modified

1. **variables.tf**: Modified `public_network_access_enabled` variable
   - Changed `default = null` to `default = true`
   - Added `nullable = false`
   - Added validation block for Premium SKU constraint

2. **migrate_main.tf**: Added field to `local.body.properties`
   - Added `publicNetworkAccess = var.public_network_access_enabled ? "Enabled" : "Disabled"`

## Implementation Verification

**Provider Behavior Replication:**
1. ✅ Default value: `true` (matches line 128)
2. ✅ Type conversion: Boolean to "Enabled"/"Disabled" enum (matches lines 465-475)
3. ✅ Validation: Premium SKU required when disabled (matches lines 468-473, 689-697)
4. ✅ Update support: Field updates in place without ForceNew (matches lines 686-698)

**No Deviations:** Implementation exactly matches provider behavior with no approximations or simplifications.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent  
**Date:** 2026-01-26  
**Task:** #10 - public_network_access_enabled

### Validation Results

✅ **ForceNew Logic:** Not required - field is updatable without resource recreation (verified in provider Update method lines 686-698)

✅ **Stable Keys:** Not applicable - no replace_triggers_external_values needed for this field

✅ **Phase Detection:** Field correctly placed in `local.body.properties` (set during primary Create operation before CreateThenPoll)

✅ **Type Conversion:** Exact conversion from Terraform bool to Azure API string ("Enabled"/"Disabled") matches provider logic (lines 465-475)

✅ **Null Handling:** Correctly implements default value with `default = true` and `nullable = false` (matches executor.md requirement for root-level arguments with defaults)

✅ **Validations:** All provider validations exactly replicated:
- Premium SKU requirement when disabled (Create: lines 468-473, Update: lines 689-697)
- Cross-variable validation implemented in `variables.tf` using Terraform 1.9+ capability
- Condition `var.public_network_access_enabled == true || var.sku == "Premium"` is logically equivalent to provider's check

✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)

✅ **Deferred Work Recording:** No deferrals made by this task

✅ **Edge Cases:** All edge cases properly analyzed and handled:
1. Disabling with non-Premium SKU - caught by validation
2. Enabling from disabled state - allowed and updates in place
3. SKU downgrade with disabled access - validation prevents
4. Default value inheritance - correctly defaults to true

✅ **Implementation Details:**
- Assignment path verification: `body.properties.publicNetworkAccess` ✅ correct
- Provider schema analysis: Optional: true, Default: true ✅ replicated
- Azure API schema: String enum ("Enabled"/"Disabled") ✅ correct conversion
- Cross-field validation: Already handled in Task #8 for export_policy_enabled ✅ verified

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:

1. **Default Value:** Matches provider default (true) with proper `nullable = false`
2. **Type Conversion:** Boolean to enum string exactly matches provider logic
3. **Validation:** Premium SKU constraint replicated exactly using cross-variable validation
4. **Update Support:** Correctly allows in-place updates without ForceNew
5. **No Deviations:** Zero simplifications or "safer alternatives" - exact replication only

**Status:** APPROVED ✅

---
