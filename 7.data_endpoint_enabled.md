# Task #7: data_endpoint_enabled - Proof Document

## Summary

Implemented `data_endpoint_enabled` as an optional boolean field that maps to `properties.dataEndpointEnabled` in the Azure API. The field has no default value and includes validation to ensure it can only be set to `true` when using Premium SKU. The field is not ForceNew and supports in-place updates.

## Shadow Implementation

```hcl
# variables.tf
variable "data_endpoint_enabled" {  # <-
  type        = bool  # <-
  default     = null  # <-
  description = "(Optional) Whether to enable dedicated data endpoints for this Container Registry? This is only supported on resources with the `Premium` SKU."  # <-

  validation {  # <-
    condition     = var.data_endpoint_enabled != true || var.sku == "Premium"  # <-
    error_message = "`data_endpoint_enabled` can only be applied when using the Premium Sku"  # <-
  }  # <-
}  # <-

# migrate_main.tf
locals {  # <-
  body = {  # <-
    properties = {  # <-
      adminUserEnabled     = var.admin_enabled  # <-
      anonymousPullEnabled = var.anonymous_pull_enabled  # <-
      dataEndpointEnabled  = var.data_endpoint_enabled  # <-
    }  # <-
    sku = {  # <-
      name = var.sku  # <-
    }  # <-
  }  # <-
}  # <-
```

## Create Phase Verification

**Query Create Method:**

From `resourceContainerRegistryCreate` (lines 405-547):

```go
parameters := registries.Registry{
    Location: location.Normalize(d.Get("location").(string)),
    Sku: registries.Sku{
        Name: registries.SkuName(sku),
        Tier: pointer.To(registries.SkuTier(sku)),
    },
    Identity: identity,
    Properties: &registries.RegistryProperties{
        AdminUserEnabled: pointer.To(d.Get("admin_enabled").(bool)),
        Encryption:       expandEncryption(d.Get("encryption").([]interface{})),
        NetworkRuleSet:   networkRuleSet,
        Policies: &registries.Policies{
            QuarantinePolicy: expandQuarantinePolicy(d.Get("quarantine_policy_enabled").(bool)),
            RetentionPolicy:  retentionPolicy,
            TrustPolicy:      trustPolicy,
            ExportPolicy:     expandExportPolicy(d.Get("export_policy_enabled").(bool)),
        },
        PublicNetworkAccess:      &publicNetworkAccess,
        ZoneRedundancy:           &zoneRedundancy,
        AnonymousPullEnabled:     pointer.To(d.Get("anonymous_pull_enabled").(bool)),
        DataEndpointEnabled:      pointer.To(d.Get("data_endpoint_enabled").(bool)),  // Line 530
        NetworkRuleBypassOptions: pointer.To(registries.NetworkRuleBypassOptions(d.Get("network_rule_bypass_option").(string))),
    },
    Tags: tags.Expand(d.Get("tags").(map[string]interface{})),
}

if err := client.CreateThenPoll(ctx, id, parameters); err != nil {
    return fmt.Errorf("creating %s: %+v", id, err)
}
```

**Pattern Identification:** Single-phase creation with one `CreateThenPoll` operation.

**Field Classification:** The field is set in the primary `parameters` struct at line 530 before the `CreateThenPoll` call. This is a **Create phase field**.

**Decision:** Implement in `local.body` in the primary resource creation.

## Assignment Path Verification

**Predicted Path:** `properties.dataEndpointEnabled`

**Go Code Evidence:**

From Create method (line 530):
```go
Properties: &registries.RegistryProperties{
    // ...
    DataEndpointEnabled: pointer.To(d.Get("data_endpoint_enabled").(bool)),
    // ...
}
```

The assignment shows:
1. Field assigned to `DataEndpointEnabled` in `registries.RegistryProperties`
2. `Properties` is set to `&registries.RegistryProperties{...}`
3. This places the field at `Properties.DataEndpointEnabled`

**Verified Path:** `properties.dataEndpointEnabled` (camelCase in Azure API)

**Path Comparison:** Predicted path matches verified path ✅

## Provider Schema

From `internal/services/containers/container_registry_resource.go` (lines 268-271):

```go
"data_endpoint_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
},
```

**Field Properties:**
- **Type:** Boolean
- **Required:** No (Optional)
- **ForceNew:** No
- **Default:** None (no Default specified)
- **Validation:** None in schema (validation in CustomizeDiff)
- **Computed:** No
- **Sensitive:** No

## Azure API Schema

**Query:** `Microsoft.ContainerRegistry/registries@2025-04-01`

**Field Path:** `body.properties.dataEndpointEnabled`

**Type:** `Bool`

**Documentation:** "Enable a single data endpoint per region for serving data."

## Hidden Fields

None. The field maps directly with no additional hidden parameters.

## Mapping

**Terraform (AzureRM):** `data_endpoint_enabled` (snake_case)  
**Azure API:** `dataEndpointEnabled` (camelCase)  
**Transformation:** Direct boolean mapping with snake_case to camelCase conversion

## Special Handling

### 1. Validation

**Provider CustomizeDiff (lines 345-347):**

```go
// data endpoint is only available for Premium Sku.
if d.Get("data_endpoint_enabled").(bool) && !strings.EqualFold(sku, string(registries.SkuNamePremium)) {
    return fmt.Errorf("`data_endpoint_enabled` can only be applied when using the Premium Sku")
}
```

**Implementation in `variables.tf`:**

```hcl
validation {
  condition     = var.data_endpoint_enabled != true || var.sku == "Premium"
  error_message = "`data_endpoint_enabled` can only be applied when using the Premium Sku"
}
```

**Validation Logic:**
- Condition: `var.data_endpoint_enabled != true || var.sku == "Premium"`
- This evaluates to true when:
  - `data_endpoint_enabled` is `null` → validation passes
  - `data_endpoint_enabled` is `false` → validation passes
  - `data_endpoint_enabled` is `true` AND `sku == "Premium"` → validation passes
  - `data_endpoint_enabled` is `true` AND `sku != "Premium"` → validation fails

This exactly matches the provider's CustomizeDiff logic where it only errors when the field is `true` AND the SKU is not Premium.

### 2. Update Support

**Provider Update Method (lines 727-729):**

```go
if d.HasChange("data_endpoint_enabled") {
    payload.Properties.DataEndpointEnabled = pointer.To(d.Get("data_endpoint_enabled").(bool))
}
```

The field supports in-place updates with no restrictions. When the value changes, it's included in the update payload.

**Implementation:** Since ForceNew is not set, the field naturally supports updates through the `body` in `azapi_resource`.

### 3. Read Support

**Provider Read Method (line 856):**

```go
d.Set("data_endpoint_enabled", props.DataEndpointEnabled)
```

The field is read back directly from the API response.

### 4. ForceNew

**Schema:** No `ForceNew: true` in schema definition.

**CustomizeDiff:** No ForceNew logic in CustomizeDiff function.

**Conclusion:** Field does NOT require replacement on change.

**Implementation:** Do NOT add to `replace_triggers_external_values`.

### 5. Default Value

**Schema:** No `Default` specified in the provider schema.

**Implementation:** Variable has `default = null` to allow the field to be omitted. When `null`, the Azure API will use its default behavior.

### 6. Sensitive Fields

Not applicable - this is a boolean configuration field, not sensitive.

## Deferred Work Completion

Checked `following.md` - file does not exist, no deferred work to complete.

## Critical Review & Edge Case Analysis

### Null Semantics
- **`null`:** Field is not set in Terraform; Azure API uses default behavior (data endpoints disabled)
- **`false`:** Explicitly disables data endpoints
- **`true`:** Explicitly enables data endpoints (requires Premium SKU)

The implementation correctly handles `null` by setting `default = null` and passing the value directly to the API.

### Boundary Conditions
- **Boolean field:** Only three possible values: `null`, `true`, `false`
- **SKU validation:** Prevents setting `true` with non-Premium SKUs at plan time

### Idempotency
- Direct value assignment ensures idempotent behavior
- No transformations or order dependencies

### Safe References
- Direct variable reference: `var.data_endpoint_enabled`
- No nested object access, no null checks needed

### Cross-Field Dependencies
- **Depends on:** `var.sku` (validation ensures Premium SKU when enabled)
- **Implementation:** Cross-variable validation in `variables.tf` (supported in Terraform 1.9+)

### API Behavior
- The field controls whether dedicated data endpoints are created per region
- When enabled with Premium SKU, provides regional data endpoints for improved performance
- The provider wraps the value in `pointer.To()` which converts Go bool to *bool for the SDK

## Checklist

- ✅ Property in correct local (`local.body.properties.dataEndpointEnabled`)
- ✅ ForceNew NOT needed (field supports in-place updates)
- ✅ All logic exactly replicated from provider (SKU validation in CustomizeDiff)
- ✅ Validation implemented in variables.tf (MANDATORY - Premium SKU requirement)
- ✅ No sensitive fields involved
- ✅ Hidden fields checked (none)
- ✅ Deferred work checked (none)
- ✅ Critical review completed (null semantics, SKU dependency)
- ✅ Edge Case Analysis in proof (boolean values, SKU validation)
- ✅ Proof created
- ✅ track.md ready for update
- ✅ Self-Review: Only data_endpoint_enabled field implemented, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-26
**Task:** #7 - data_endpoint_enabled

### Validation Results

✅ **ForceNew Logic:** Simple non-ForceNew field - no replacement needed, supports in-place updates
✅ **Stable Keys:** Not applicable (field is not ForceNew)
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, line 530 in provider)
✅ **Type Conversion:** Direct boolean mapping, no conversion needed
✅ **Null Handling:** Correctly propagates null semantics (`default = null` allows field to be omitted)
✅ **Validations:** Cross-variable validation implemented in `variables.tf` (Premium SKU requirement from CustomizeDiff lines 345-347)
✅ **Deferred Work Completion:** No deferred work for this task (`following.md` does not exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Boolean field with three values (null/false/true), SKU dependency validated at plan time
✅ **Assignment Path:** Correctly verified `Properties.DataEndpointEnabled` → `properties.dataEndpointEnabled`
✅ **Proof Quality:** All required sections present with Go code evidence, no forbidden phrases

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:
- CustomizeDiff validation (lines 345-347) replicated as cross-variable validation using Terraform 1.9+ features
- Update support (lines 727-729) preserved through `body` placement
- No ForceNew logic (schema and CustomizeDiff have none)
- Proper null semantics maintained
- No deviations, simplifications, or "safer alternatives" found

**Status:** APPROVED ✅

---
