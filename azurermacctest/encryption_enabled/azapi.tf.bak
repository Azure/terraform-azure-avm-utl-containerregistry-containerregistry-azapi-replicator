module "replicator" {
  source = "../../"

  name              = "testacccr${random_integer.number.result}"
  resource_group_id = azurerm_resource_group.test.id
  location          = azurerm_resource_group.test.location
  sku               = "Premium"
  enable_telemetry  = false

  identity = {
    type = "UserAssigned"
    identity_ids = toset([
      azurerm_user_assigned_identity.test.id
    ])
  }

  encryption = [{
    identity_client_id = azurerm_user_assigned_identity.test.client_id
    key_vault_key_id   = azurerm_key_vault_key.test.id
  }]
}

resource "azapi_resource" "this" {
  type                             = module.replicator.azapi_header.type
  name                             = module.replicator.azapi_header.name
  location                         = module.replicator.azapi_header.location
  parent_id                        = module.replicator.azapi_header.parent_id
  tags                             = module.replicator.azapi_header.tags
  body                             = module.replicator.body
  ignore_null_property             = module.replicator.azapi_header.ignore_null_property
  sensitive_body                   = module.replicator.sensitive_body
  sensitive_body_version           = module.replicator.sensitive_body_version
  replace_triggers_external_values = module.replicator.replace_triggers_external_values
  locks                            = module.replicator.locks
  retry                            = module.replicator.retry

  dynamic "identity" {
    for_each = try(module.replicator.azapi_header.identity != null, false) ? [module.replicator.azapi_header.identity] : []
    content {
      type         = identity.value.type
      identity_ids = try(identity.value.identity_ids, null)
    }
  }

  dynamic "timeouts" {
    for_each = module.replicator.timeouts != null ? [module.replicator.timeouts] : []
    content {
      create = timeouts.value.create
      delete = timeouts.value.delete
      read   = timeouts.value.read
      update = timeouts.value.update
    }
  }
}

resource "azapi_resource" "post_creation0" {
  count          = module.replicator.post_creation0 != null ? 1 : 0
  type           = module.replicator.post_creation0.azapi_header.type
  name           = module.replicator.post_creation0.azapi_header.name
  parent_id      = azapi_resource.this.id
  body           = module.replicator.post_creation0.body
  sensitive_body = module.replicator.post_creation0_sensitive_body
  locks          = module.replicator.post_creation0.locks
  depends_on     = [azapi_resource.this]

  lifecycle {
    ignore_changes = [body, sensitive_body]
  }

  dynamic "timeouts" {
    for_each = module.replicator.timeouts != null ? [module.replicator.timeouts] : []
    content {
      create = timeouts.value.create
      delete = timeouts.value.delete
      read   = timeouts.value.read
      update = timeouts.value.update
    }
  }
}
