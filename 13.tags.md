# Task #13 - tags - Proof Document

## Summary

The `tags` field is a root-level optional argument that allows users to assign metadata key-value pairs to the Container Registry resource. It is already correctly implemented in `azapi_header` and requires no changes to the existing code.

## Shadow Implementation

```hcl
# In migrate_main.tf (already exists)
locals {
  azapi_header = {
    type                  = "Microsoft.ContainerRegistry/registries@2025-04-01"
    name                  = var.name
    location              = var.location
    parent_id             = var.resource_group_id
    tags                  = var.tags  # <-
    ignore_null_property  = true
    retry                 = null
  }
}
```

```hcl
# In variables.tf (already exists)
variable "tags" {
  type        = map(string)  # <-
  default     = null  # <-
  description = "(Optional) A mapping of tags to assign to the resource."  # <-
}
```

## Create Phase Verification

**Query:** Examined `resourceContainerRegistryCreate` function (lines 387-546).

**Pattern:** Single-phase creation with one `CreateThenPoll` operation.

**Go Code Evidence - Create (Line 521):**
```go
parameters := registries.Registry{
    Location: location.Normalize(d.Get("location").(string)),
    Sku: registries.Sku{
        Name: registries.SkuName(sku),
        Tier: pointer.To(registries.SkuTier(sku)),
    },
    Identity: identity,
    Properties: &registries.RegistryProperties{
        // ... properties ...
    },

    Tags: tags.Expand(d.Get("tags").(map[string]interface{})),  // <-- Tags at root level
}

if err := client.CreateThenPoll(ctx, id, parameters); err != nil {
    return fmt.Errorf("creating %s: %+v", id, err)
}
```

**Classification:** The `tags` field is set in the primary `registries.Registry` struct before the single `CreateThenPoll` operation. This is a **Create phase** field.

**Decision:** Implement in `local.azapi_header` (already done).

## Assignment Path Verification

**Predicted Path:** `tags` (root-level in Azure API)

**Go Code Evidence:**

1. **Schema Definition (Line 286):**
```go
"tags": commonschema.Tags(),
```

2. **Struct Assignment in Create (Lines 390-521):**
```go
parameters := registries.Registry{
    Location: location.Normalize(d.Get("location").(string)),
    Sku: registries.Sku{
        Name: registries.SkuName(sku),
        Tier: pointer.To(registries.SkuTier(sku)),
    },
    Identity: identity,
    Properties: &registries.RegistryProperties{
        AdminUserEnabled: pointer.To(d.Get("admin_enabled").(bool)),
        // ... other properties ...
    },
    Tags: tags.Expand(d.Get("tags").(map[string]interface{})),  // <-- Root level
}
```

**Verified Path:** `tags` (root-level, not nested in `Properties`)

**Path Comparison:** ✅ **MATCH** - `tags` is a root-level field in the Azure API, not inside `properties`.

**AzAPI Implementation:** In `azapi_resource`, `tags` is a top-level parameter (like `name`, `location`), not inside `body`. This is correctly implemented in `local.azapi_header`.

## Provider Schema

**Source:** `internal/services/containers/container_registry_resource.go` (Line 286)

```go
"tags": commonschema.Tags(),
```

**Attributes:**
- **Type:** `TypeString` (map)
- **Required:** No
- **Optional:** Yes (implied by commonschema.Tags())
- **ForceNew:** No
- **Default:** None
- **Computed:** No
- **DiffSuppressFunc:** No
- **ValidateFunc:** None (standard tags validation from commonschema)

**commonschema.Tags() Standard Behavior:**
- Accepts `map[string]string`
- Allows null (optional)
- No diff suppression
- Standard tags expansion/flattening

## Azure API Schema

**Query:** `query_azapi_resource_schema` for `Microsoft.ContainerRegistry/registries@2025-04-01` with path `tags`

**Result:** `Map(String)`

**API Path:** `tags` (root-level, not `properties.tags`)

**Type:** Map of string to string

## Hidden Fields

**Check:** None. The `tags` field is explicitly defined in the schema and has no hidden companion fields.

## Mapping

**Provider (snake_case):** `tags`

**Azure API (camelCase):** `tags`

**Mapping:** Direct mapping, no case conversion needed for the field name itself.

## Special Handling

### 1. ForceNew Analysis

**Schema Check:** No `ForceNew: true` in schema.

**CustomizeDiff Check:** Reviewed `CustomizeDiff` function (lines 289-390). No logic involving `tags` field.

**Create/Update Logic:**
- **Create (Line 521):** `Tags: tags.Expand(d.Get("tags").(map[string]interface{}))`
- **Update (Lines 654-656):**
```go
if d.HasChange("tags") {
    payload.Tags = tags.Expand(d.Get("tags").(map[string]interface{}))
}
```

**Conclusion:** Tags are updatable in place. No ForceNew behavior.

**Implementation:** ❌ No entry in `replace_triggers_external_values` needed.

### 2. Sensitive Field Analysis

**Schema:** No `Sensitive: true` attribute.

**Azure API:** Tags are not write-only fields.

**Conclusion:** Not a sensitive field.

**Implementation:** ❌ Not in `sensitive_body`.

### 3. Validation Analysis

**Provider Schema:** Uses `commonschema.Tags()` which has standard tags validation built-in.

**Custom Validation:** None in the provider source code.

**Implementation in variables.tf:** The existing variable definition is correct:
```hcl
variable "tags" {
  type        = map(string)
  default     = null
  description = "(Optional) A mapping of tags to assign to the resource."
}
```

**Terraform's Built-in Validation:** Terraform automatically validates `map(string)` type, ensuring all values are strings.

**Conclusion:** No additional validation blocks required. The type constraint is sufficient.

### 4. Default Value

**Provider Schema (Line 286):** `commonschema.Tags()` - no explicit default value, implicitly `nil`/`null`.

**Implementation:** Already correct in `variables.tf`:
```hcl
variable "tags" {
  type        = map(string)
  default     = null  # <-- Correct
  description = "(Optional) A mapping of tags to assign to the resource."
}
```

**Note:** Tags should NOT have `nullable = false` because it's an optional field that can be null.

### 5. Post-Creation Operations

**Analysis:** Tags are set during the primary `CreateThenPoll` operation. No post-creation operations for tags.

**Update Handling:** Tags can be updated via the `UpdateThenPoll` operation with `payload.Tags`.

**Conclusion:** No post-creation operations needed.

## Deferred Work Completion

**Check:** Reviewed `following.md` - file does not exist, indicating no work was deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics
- **Provider:** `tags` is optional and can be `nil`
- **AzAPI:** When `var.tags` is `null`, it is passed as-is to `azapi_header.tags`
- **Azure Behavior:** Null tags means no tags are set on the resource
- **Idempotency:** ✅ Correctly handles null → no tags, consistent behavior

### Empty Map vs Null
- **Empty map (`{}`):** Sets no tags on the resource (same effect as null in Azure)
- **Null:** No tags parameter sent
- **Implementation:** Both handled correctly by `tags = var.tags` in azapi_header

### Tag Updates
- **Adding tags:** `null` → `{"key": "value"}` - Updates in place ✅
- **Removing tags:** `{"key": "value"}` → `null` - Updates in place ✅
- **Modifying tags:** `{"key": "old"}` → `{"key": "new"}` - Updates in place ✅
- **Partial updates:** Azure replaces entire tag collection (standard behavior) ✅

### Safe References
- **Direct assignment:** `tags = var.tags` is safe
- **No nested access:** No null pointer risks ✅

### Special Considerations for Tags in AzAPI

**Root-Level Placement:** Unlike most other fields, `tags` is NOT in `body` but directly in `azapi_resource`:
```hcl
resource "azapi_resource" "this" {
  type = local.azapi_header.type
  name = local.azapi_header.name
  location = local.azapi_header.location
  parent_id = local.azapi_header.parent_id
  tags = local.azapi_header.tags  # <-- Root level, not in body
  body = local.body
  # ...
}
```

This is correctly implemented in our `local.azapi_header`.

## Implementation Status

✅ **Already Implemented** - No changes required.

The `tags` field is already correctly implemented in `migrate_main.tf` at line 7:
```hcl
tags = var.tags
```

The variable is already correctly defined in `variables.tf` at lines 212-216:
```hcl
variable "tags" {
  type        = map(string)
  default     = null
  description = "(Optional) A mapping of tags to assign to the resource."
}
```

## Checklist

- ✅ Property in correct local (`azapi_header`, not `body`)
- ✅ ForceNew wrapped: N/A (not ForceNew)
- ✅ All logic exactly replicated from provider (direct pass-through, no transformations)
- ✅ Validations implemented: N/A (type constraint sufficient)
- ✅ TODO comment: N/A (not a sensitive field)
- ✅ Hidden fields checked: None
- ✅ Deferred work in following.md: N/A (not deferring anything)
- ✅ Deferred work from following.md: None to complete
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof: Included above
- ✅ Proof created: This document
- ✅ Self-Review: Only `tags` field addressed, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-26
**Task:** #13 - tags

### Validation Results

✅ **Field Location:** Correctly placed in `azapi_header` (root-level), not in `body` - matches Azure API schema
✅ **Variable Definition:** Correct type `map(string)`, correct default `null` (no provider default exists), correctly omits `nullable = false` (only required when provider has Default value)
✅ **ForceNew Logic:** N/A - tags are updatable in place, no ForceNew behavior in provider
✅ **Stable Keys:** N/A - no `replace_triggers_external_values` entries needed
✅ **Phase Detection:** Correctly identified as Create phase field
✅ **Type Conversion:** Direct mapping `map(string)` → tags parameter
✅ **Null Handling:** Correctly propagates null semantics (null = no tags)
✅ **Validations:** None required beyond type constraint (commonschema.Tags() has standard validation)
✅ **Sensitive Field:** Not sensitive, correctly placed in `azapi_header` not `sensitive_body`
✅ **Deferred Work Completion:** No deferred work for this task (no following.md exists)
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** Comprehensive edge case analysis provided (null vs empty map, updates, idempotency)
✅ **Assignment Path:** Correctly verified tags is root-level in Azure API, not nested in properties
✅ **Implementation Status:** Already correctly implemented in Task #1, no changes needed

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The `tags` field is a root-level parameter that:
1. Maps directly from Terraform's `map(string)` to Azure API's tags parameter
2. Is optional with no default value (null allowed)
3. Is updatable in place (no ForceNew)
4. Has no special validations beyond type constraint
5. Is correctly placed in `azapi_header` for root-level azapi_resource parameter

The executor correctly identified that this field was already implemented in Task #1 (azapi_header creation) and required no additional implementation work. The proof document provides complete traceability with Go code evidence and comprehensive edge case analysis.

**Status:** APPROVED ✅

---
