# Task #6: anonymous_pull_enabled - Proof Document

## Summary

Implemented `anonymous_pull_enabled` as an optional boolean field mapped to Azure API's `properties.anonymousPullEnabled`. The field includes SKU validation (Standard/Premium only) and is updatable without ForceNew.

## Shadow Implementation

```hcl
# variables.tf
variable "anonymous_pull_enabled" {                                                   # <-
  type        = bool                                                                  # <-
  default     = null                                                                  # <-
  description = "(Optional) Whether to allow anonymous (unauthenticated) pull access to this Container Registry. This is only supported on resources with the `Standard` or `Premium` SKU." # <-
                                                                                      # <-
  validation {                                                                        # <-
    condition     = var.anonymous_pull_enabled == null || var.anonymous_pull_enabled == false || contains(["Standard", "Premium"], var.sku) # <-
    error_message = "`anonymous_pull_enabled` can only be applied when using the Standard/Premium Sku" # <-
  }                                                                                   # <-
}                                                                                     # <-

# migrate_main.tf
locals {                                                                              # <-
  body = {                                                                            # <-
    properties = {                                                                    # <-
      adminUserEnabled     = var.admin_enabled                                        # <-
      anonymousPullEnabled = var.anonymous_pull_enabled                               # <-
    }                                                                                 # <-
    sku = {                                                                           # <-
      name = var.sku                                                                  # <-
    }                                                                                 # <-
  }                                                                                   # <-
}                                                                                     # <-
```

## Create Phase Verification

**Query:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern Identification:** Single-phase creation (one `CreateOrUpdateThenPoll`)

**Evidence from Create method (line 527):**
```go
parameters := registries.Registry{
    Location: location.Normalize(d.Get("location").(string)),
    Sku: registries.Sku{
        Name: registries.SkuName(sku),
        Tier: pointer.To(registries.SkuTier(sku)),
    },
    Identity: identity,
    Properties: &registries.RegistryProperties{
        AdminUserEnabled: pointer.To(d.Get("admin_enabled").(bool)),
        // ... other fields ...
        AnonymousPullEnabled:     pointer.To(d.Get("anonymous_pull_enabled").(bool)), // <- Field set during Create
        DataEndpointEnabled:      pointer.To(d.Get("data_endpoint_enabled").(bool)),
        NetworkRuleBypassOptions: pointer.To(registries.NetworkRuleBypassOptions(d.Get("network_rule_bypass_option").(string))),
    },
    Tags: tags.Expand(d.Get("tags").(map[string]interface{})),
}

if err := client.CreateThenPoll(ctx, id, parameters); err != nil {
    return fmt.Errorf("creating %s: %+v", id, err)
}
```

**Decision:** Field is set during the primary Create operation → Belongs in `local.body`, NOT in post-creation operations.

## Assignment Path Verification

**Predicted Path:** `properties.anonymousPullEnabled`

**Go Code Evidence (lines 527-540):**
```go
parameters := registries.Registry{
    // ... other fields ...
    Properties: &registries.RegistryProperties{
        AdminUserEnabled: pointer.To(d.Get("admin_enabled").(bool)),
        // ... other fields ...
        AnonymousPullEnabled:     pointer.To(d.Get("anonymous_pull_enabled").(bool)), // <- Direct assignment to Properties
        DataEndpointEnabled:      pointer.To(d.Get("data_endpoint_enabled").(bool)),
        // ... other fields ...
    },
    Tags: tags.Expand(d.Get("tags").(map[string]interface{})),
}
```

**Tracing:**
1. `parameters` is of type `registries.Registry`
2. `parameters.Properties` is assigned `&registries.RegistryProperties{...}`
3. Within `RegistryProperties`, `AnonymousPullEnabled` is directly set
4. Therefore, the path is: `properties.anonymousPullEnabled`

**Verified Path:** `properties.anonymousPullEnabled`

**Path Comparison:** Predicted path MATCHES verified path ✅

## Provider Schema

**Schema Definition (lines 263-266):**
```go
"anonymous_pull_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
},
```

**Attributes:**
- **Type:** `TypeBool`
- **Required:** `false` (Optional)
- **Default:** None (no default specified)
- **ForceNew:** `false` (not specified)
- **Computed:** `false`
- **Sensitive:** `false`
- **MaxItems:** N/A (not a list/block)

## Azure API Schema

**API Version:** `2025-04-01`

**Resource Type:** `Microsoft.ContainerRegistry/registries`

**Field Path:** `body.properties.anonymousPullEnabled`

**Field Type:** `Bool`

**Field Description:** "Enables registry-wide pull from unauthenticated clients."

## Hidden Fields

**None.** No hardcoded values or hidden fields associated with `anonymous_pull_enabled`.

## Mapping

**Terraform (snake_case) → Azure API (camelCase):**
- `anonymous_pull_enabled` → `anonymousPullEnabled`

## Special Handling

### 1. Validation

**CustomizeDiff Validation (lines 359-361):**
```go
// anonymous pull is only available for Standard/Premium Sku.
if d.Get("anonymous_pull_enabled").(bool) && (!strings.EqualFold(sku, string(registries.SkuNameStandard)) && !strings.EqualFold(sku, string(registries.SkuNamePremium))) {
    return fmt.Errorf("`anonymous_pull_enabled` can only be applied when using the Standard/Premium Sku")
}
```

**Implementation in `variables.tf`:**
```hcl
validation {
  condition     = var.anonymous_pull_enabled == null || var.anonymous_pull_enabled == false || contains(["Standard", "Premium"], var.sku)
  error_message = "`anonymous_pull_enabled` can only be applied when using the Standard/Premium Sku"
}
```

**Logic Explanation:**
- Provider checks: `anonymous_pull_enabled == true AND sku NOT IN (Standard, Premium)` → Error
- Terraform validation: Allow if `null`, `false`, or `true with sku IN (Standard, Premium)`
- The condition exactly replicates provider behavior

### 2. ForceNew

**NOT REQUIRED.** The schema does NOT specify `ForceNew: true` for this field.

**Update Support Evidence (lines 716-718):**
```go
if d.HasChange("anonymous_pull_enabled") {
    payload.Properties.AnonymousPullEnabled = pointer.To(d.Get("anonymous_pull_enabled").(bool))
}
```

The provider explicitly supports in-place updates for this field.

### 3. Sensitive Fields

**NOT APPLICABLE.** The field is not marked as `Sensitive: true`.

### 4. Post-Creation Operations

**NOT APPLICABLE.** The field is set during the primary Create operation, not in a post-creation phase.

### 5. Default Value

**No Default.** The schema does NOT specify a `Default` value. The variable is declared with `default = null`.

**Provider Behavior:**
- When not set (null), the provider passes `pointer.To(false)` to the API (since `d.Get("anonymous_pull_enabled").(bool)` returns `false` for nil)
- This is standard Go behavior where accessing a boolean from a nil value returns `false`

**Implementation:** Variable `default = null` matches provider schema (no explicit default).

## Deferred Work Completion

**No deferred work.** Checked `following.md` - file does not exist, indicating no work was deferred to this task.

## Critical Review & Edge Case Analysis

### 1. Null Semantics
- **Null meaning:** When `var.anonymous_pull_enabled` is `null`, Go's `d.Get("anonymous_pull_enabled").(bool)` returns `false`
- **Provider behavior:** Passes `pointer.To(false)` to Azure API
- **Implementation:** `anonymousPullEnabled = var.anonymous_pull_enabled` - when null, Terraform will omit from body (with `ignore_null_property = true`), Azure uses default behavior
- **Idempotency:** ✅ First apply with null → Azure defaults; subsequent applies with null → no change

### 2. Edge Cases
- **Empty value:** N/A (boolean type)
- **Zero value:** `false` - Valid value, explicitly disables anonymous pull
- **True with Basic SKU:** Validation block prevents this at plan time
- **Null value:** Allowed, results in Azure default behavior

### 3. Idempotency
- **Boolean field:** No ordering concerns
- **No computed values:** Field is directly user-specified
- **Validation runs at plan time:** Prevents invalid SKU combinations before apply

### 4. Safe References
- **Direct reference:** `var.anonymous_pull_enabled` is safe (primitive boolean)
- **No nested access:** No risk of null pointer dereferencing
- **SKU validation references:** `var.sku` exists (required field from Task #4)

### 5. State Handling
- **Read implementation (line 857):** `d.Set("anonymous_pull_enabled", props.AnonymousPullEnabled)`
- **API returns:** Pointer to boolean (`*bool`)
- **State behavior:** When API returns `nil`, Terraform sets `null`; when `true/false`, sets accordingly

## Checklist

- ✅ Property in correct local (`body.properties.anonymousPullEnabled`)
- ✅ ForceNew NOT required (field supports in-place updates)
- ✅ ALL logic EXACTLY replicated from provider (SKU validation)
- ✅ Validations IMPLEMENTED in variables.tf (SKU constraint)
- ✅ TODO comment NOT needed (not a sensitive field with independent variable)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md: N/A (no work deferred to other tasks)
- ✅ Deferred work from following.md: None found (following.md doesn't exist)
- ✅ Critical review (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Self-Review: ONLY anonymous_pull_enabled implemented, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-26
**Task:** #6 - anonymous_pull_enabled

### Validation Results

✅ **ForceNew Logic:** NOT required - field supports in-place updates (verified in Update method)
✅ **Stable Keys:** No ForceNew keys needed for this field
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Boolean to Boolean - correct direct assignment
✅ **Null Handling:** Correctly propagates null semantics (null omitted with ignore_null_property)
✅ **Validations:** CustomizeDiff SKU validation EXACTLY replicated in variables.tf
✅ **Deferred Work Completion:** No deferred work for this task (following.md doesn't exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null, false, true with SKU constraints)
✅ **Cross-Variable Validation:** Correct implementation referencing var.sku
✅ **Default Value:** Correctly set to null (no provider default)
✅ **Nullable Attribute:** Correctly NOT set to false (field has no default)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The validation logic correctly implements the SKU constraint check using Terraform 1.9+ cross-variable validation syntax.

**Status:** APPROVED ✅

---
