# Task #9: network_rule_bypass_option - Proof Document

## Summary

Migrated the `network_rule_bypass_option` argument from `azurerm_container_registry` to `azapi_resource`. This is a simple optional field with a default value of "AzureServices" that maps to `body.properties.networkRuleBypassOptions` in the Azure API.

## Shadow Implementation

```hcl
# variables.tf
variable "network_rule_bypass_option" {
  type        = string
  default     = "AzureServices"  # <-
  nullable    = false  # <-
  description = "(Optional) Whether to allow trusted Azure services to access a network-restricted Container Registry? Possible values are `None` and `AzureServices`. Defaults to `AzureServices`."

  validation {  # <-
    condition     = contains(["AzureServices", "None"], var.network_rule_bypass_option)  # <-
    error_message = "'network_rule_bypass_option' must be one of: AzureServices, None"  # <-
  }  # <-
}

# migrate_main.tf
locals {
  body = {
    properties = {
      networkRuleBypassOptions = var.network_rule_bypass_option  # <-
      # other fields...
    }
  }
}
```

## Create Phase Verification

### Query Create Method
From `internal/services/containers/container_registry_resource.go`:

```go
func resourceContainerRegistryCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... (lines 405-519)
	
	parameters := registries.Registry{
		Location: location.Normalize(d.Get("location").(string)),
		Sku: registries.Sku{
			Name: registries.SkuName(sku),
			Tier: pointer.To(registries.SkuTier(sku)),
		},
		Identity: identity,
		Properties: &registries.RegistryProperties{
			// ... other fields
			NetworkRuleBypassOptions: pointer.To(registries.NetworkRuleBypassOptions(d.Get("network_rule_bypass_option").(string))),
		},

		Tags: tags.Expand(d.Get("tags").(map[string]interface{})),
	}

	if err := client.CreateThenPoll(ctx, id, parameters); err != nil {
		return fmt.Errorf("creating %s: %+v", id, err)
	}
	// ... (lines 522-538)
}
```

### Pattern Identification
**Pattern:** Single-phase creation
- **Primary Operation:** `client.CreateThenPoll(ctx, id, parameters)` (line 521)
- **No Additional Operations:** After the primary create operation completes, no additional SDK operations are performed for this field

### Field Classification
**Decision:** The field is set during the **Create phase** in the primary `CreateThenPoll` operation.

**Placement:** `local.body.properties.networkRuleBypassOptions`

## Assignment Path Verification

### Predicted Path
`body → properties → networkRuleBypassOptions`

### Go Code Evidence
From Create method (line 520):
```go
Properties: &registries.RegistryProperties{
	AdminUserEnabled: pointer.To(d.Get("admin_enabled").(bool)),
	Encryption:       expandEncryption(d.Get("encryption").([]interface{})),
	NetworkRuleSet:   networkRuleSet,
	Policies: &registries.Policies{
		QuarantinePolicy: expandQuarantinePolicy(d.Get("quarantine_policy_enabled").(bool)),
		RetentionPolicy:  retentionPolicy,
		TrustPolicy:      trustPolicy,
		ExportPolicy:     expandExportPolicy(d.Get("export_policy_enabled").(bool)),
	},
	PublicNetworkAccess:      &publicNetworkAccess,
	ZoneRedundancy:           &zoneRedundancy,
	AnonymousPullEnabled:     pointer.To(d.Get("anonymous_pull_enabled").(bool)),
	DataEndpointEnabled:      pointer.To(d.Get("data_endpoint_enabled").(bool)),
	NetworkRuleBypassOptions: pointer.To(registries.NetworkRuleBypassOptions(d.Get("network_rule_bypass_option").(string))),
},
```

**Assignment trace:**
1. `parameters.Properties = &registries.RegistryProperties{...}` - sets Properties field
2. Within RegistryProperties struct: `NetworkRuleBypassOptions: pointer.To(...)` - sets NetworkRuleBypassOptions field

### Verified Path
`body → properties → networkRuleBypassOptions`

### Path Comparison
✅ **MATCH** - Predicted path matches the verified path from Go code

## Provider Schema

### Schema Definition
From `internal/services/containers/container_registry_resource.go` (lines 277-284):

```go
"network_rule_bypass_option": {
	Type:     pluginsdk.TypeString,
	Optional: true,
	ValidateFunc: validation.StringInSlice([]string{
		string(registries.NetworkRuleBypassOptionsAzureServices),
		string(registries.NetworkRuleBypassOptionsNone),
	}, false),
	Default: string(registries.NetworkRuleBypassOptionsAzureServices),
},
```

**Key Properties:**
- **Type:** String
- **Optional:** true
- **Default:** "AzureServices"
- **Validation:** Must be one of: "AzureServices", "None"
- **ForceNew:** false (not specified, so updates are allowed)

## Azure API Schema

### Resource Type
`Microsoft.ContainerRegistry/registries@2025-04-01`

### Property Path
`body.properties.networkRuleBypassOptions`

### Type
`String`

### Documentation
"Whether to allow trusted Azure services to access a network restricted registry. (Possible values: AzureServices,None)"

## Hidden Fields

**None identified.** The field is directly mapped from the schema to the API without any hidden transformations or additional fields.

## Mapping

| Provider (snake_case) | Azure API (camelCase) | Notes |
|---|---|---|
| `network_rule_bypass_option` | `networkRuleBypassOptions` | Direct string mapping |

## Special Handling

### Validation
**Implementation in `variables.tf`:**

```hcl
validation {
  condition     = contains(["AzureServices", "None"], var.network_rule_bypass_option)
  error_message = "'network_rule_bypass_option' must be one of: AzureServices, None"
}
```

**Evidence from Provider Schema (lines 279-282):**
```go
ValidateFunc: validation.StringInSlice([]string{
	string(registries.NetworkRuleBypassOptionsAzureServices),
	string(registries.NetworkRuleBypassOptionsNone),
}, false),
```

### Default Value
**Implementation in `variables.tf`:**
```hcl
default  = "AzureServices"
nullable = false
```

**Evidence from Provider Schema (line 283):**
```go
Default: string(registries.NetworkRuleBypassOptionsAzureServices),
```

The `nullable = false` ensures that the default value is always applied when not explicitly set, matching the provider's behavior.

### ForceNew
**Not Required.** The schema does not specify `ForceNew: true`, and the Update method handles changes to this field:

From Update method (lines 673-675):
```go
if d.HasChange("network_rule_bypass_option") {
	payload.Properties.NetworkRuleBypassOptions = pointer.To(registries.NetworkRuleBypassOptions(d.Get("network_rule_bypass_option").(string)))
}
```

Therefore, changes to this field can be updated in-place without forcing resource recreation.

### Sensitive
**Not applicable.** The field is not marked as `Sensitive: true` in the schema.

## Deferred Work Completion

Checked `following.md` - file does not exist. No deferred work for this task.

## Edge Case Analysis

### Null Semantics
- **Provider behavior:** When not specified, defaults to "AzureServices"
- **Implementation:** Set `default = "AzureServices"` with `nullable = false`
- **Result:** Variable always has a value, matching provider behavior exactly

### Empty String
- **Provider behavior:** Would fail validation (not in allowed values list)
- **Implementation:** Validation block prevents empty strings and enforces enum values
- **Result:** Matches provider validation

### Invalid Values
- **Provider behavior:** Validation fails at plan time with `StringInSlice` validator
- **Implementation:** Validation block enforces the same allowed values
- **Result:** Exact match - fails fast at plan time

### Case Sensitivity
- **Provider behavior:** Case-sensitive validation (`false` parameter in `StringInSlice`)
- **Implementation:** `contains()` is case-sensitive by default
- **Result:** Exact match - must use exact casing

### Idempotency
- **Single value:** No ordering issues
- **Fixed default:** Always produces the same result when unset
- **Result:** Fully idempotent

### Safe References
- **Direct variable reference:** `var.network_rule_bypass_option`
- **Always has value:** Due to `nullable = false` and default value
- **Result:** No nil dereference risks

## Checklist

- ✅ Property in correct local (`local.body.properties.networkRuleBypassOptions`)
- ✅ ForceNew not needed (field supports in-place updates)
- ✅ All logic exactly replicated from provider (simple string mapping with validation and default)
- ✅ Validation implemented in `variables.tf` (enum validation matching `StringInSlice`)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work checked (no following.md file exists)
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis included (null, empty, invalid, case sensitivity, idempotency, safe references)
- ✅ Proof created
- ✅ track.md will be updated to `Pending for check`
- ✅ Self-Review: Only implemented network_rule_bypass_option, did not add unrelated fields

## Implementation Verification

The implementation exactly replicates the provider behavior:
1. ✅ **Type:** String (matches provider schema)
2. ✅ **Optional with default:** Variable has `default = "AzureServices"` and `nullable = false`
3. ✅ **Validation:** Enum validation matches `StringInSlice` validator
4. ✅ **Mapping:** Correctly maps to `properties.networkRuleBypassOptions`
5. ✅ **Update support:** No ForceNew needed (provider supports in-place updates)
6. ✅ **No special transformations:** Direct value passthrough

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-26
**Task:** #9 - network_rule_bypass_option

### Validation Results

✅ **ForceNew Logic:** Not required - field supports in-place updates (confirmed by Update method handling)
✅ **Stable Keys:** Not applicable - field not in `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Correct - string to string, no conversion needed
✅ **Null Handling:** Correctly handled - `nullable = false` with default value ensures non-null
✅ **Validations:** All provider validations implemented exactly (StringInSlice → contains check)
✅ **Root-Level Default:** CRITICAL requirement met - both `default` and `nullable = false` present
✅ **Mapping:** Correct camelCase conversion (network_rule_bypass_option → networkRuleBypassOptions)
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled (null, empty, invalid values, case sensitivity, idempotency)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found.

**Key Compliance Points:**
- Root-level argument with default correctly implements BOTH `default` value AND `nullable = false` (executor.md requirement)
- Validation exactly matches provider's `StringInSlice` validator with same allowed values and case sensitivity
- Default value matches provider schema exactly ("AzureServices")
- Proper placement in Create phase body structure
- Correct Azure API path mapping with camelCase conversion
- No unnecessary ForceNew trigger (provider supports updates)

**Status:** APPROVED ✅

---
